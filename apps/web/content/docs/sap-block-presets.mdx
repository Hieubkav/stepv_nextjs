---
title: SAP - Block Presets Form Builder
description: Scaffold, Approach, Pattern và Feynman cho kiến trúc block-presets mới (schema + data tách riêng, icon registry)
---

## Mục tiêu

- Chuẩn hóa cách định nghĩa form Home Blocks bằng một registry duy nhất, có thể mở rộng tự động.
- Tách rõ **schema/ui** và **data mặc định** để không phải copy/paste template giữa nhiều file.
- Đảm bảo admin chỉ cần chọn preset → có sẵn dữ liệu mẫu, icon chọn nhanh, array dài có thể thu gọn.

## SAP

### Scaffold

- `apps/web/src/components/blocks/block-presets.ts`: chứa `BLOCK_PRESETS` mô tả `kind`, `schema`, `uiSchema`, liên kết tới data mặc định bằng `BLOCK_DEFAULT_DATA[kind]`.
- `apps/web/src/components/blocks/block-defaults.ts`: nguồn dữ liệu mẫu (template) cho từng `kind`, có thể tái sử dụng ở bất kỳ đâu.
- `apps/web/src/components/blocks/block-form.tsx`: render form (`@rjsf`) + template array có toggle, widget icon/media.
- `apps/web/src/lib/lucide-icons.ts`: registry Lucide icon phổ biến (Sparkles, Box, Lightbulb, ...), cung cấp `ICON_OPTIONS`, `ICON_ONE_OF`, `getLucideIcon`.
- `apps/web/src/components/sections/**/*Section.tsx`: các section site sử dụng `getLucideIcon` → icon đồng bộ với preset.
- Tài liệu liên quan: `sap-json-to-form.mdx` (tổng quan JSON→Form), file này mô tả cụ thể preset.

### Approach

1. **Preset Schema**: Mỗi block khai báo `schema` + `uiSchema` (RJSF) + `template: BLOCK_DEFAULT_DATA[kind]`. Khi thêm block mới chỉ cần thêm 1 object.
2. **Data Defaults**: `block-defaults.ts` giữ mọi template JSON. `block-templates.ts` chỉ clone `BLOCK_DEFAULT_DATA[kind]` → không còn duplication.
3. **Form Engine**: `BlockForm` dựng map `kind → preset`, pass schema/ui vào `<Form>`. Array dài dùng `ArrayFieldTemplate` mới (toggle + header).
4. **Widgets**: Widget `iconPicker` đọc `ICON_OPTIONS`; media widget bật dialog; các input đều dùng component shadcn.
5. **Icon Registry**: Mọi icon string (services, why3D, weWork, ...) chuyển sang mã Lucide (Film, Lightbulb, Box, ...). Sections render icon bằng `getLucideIcon` để khớp dữ liệu mới.
6. **Build Guard**: `bun run --cwd apps/web build` đảm bảo preset + defaults + icon registry đồng bộ (thất bại nếu icon chưa có export).

### Pattern

- **Single Source Registry**: `BLOCK_PRESETS` + `BLOCK_DEFAULT_DATA` = 1 nguồn sự thật, tránh mất đồng bộ giữa form / template.
- **Schema-driven UI**: Form được sinh hoàn toàn từ JSON Schema, dễ thêm trường mới mà không code tay.
- **Data/Schema Separation**: Template rời sang `block-defaults.ts` → có thể tái sử dụng cho seed, preview, tests.
- **Icon Catalog**: Lucide icon map cung cấp `ICON_ONE_OF` cho JSON schema (`oneOf`) → dropdown icon đẹp + ảnh trực quan.
- **UX Array Toggle**: Array Field Template mới cho phép thu gọn item (đặc biệt list topCards, CTA...), giảm “bức tường form”.
- **Media Integration**: Widgets tái sử dụng để mở dialog chọn media, apply nhất quán mọi preset.

## Chi tiết

- `block-presets.ts`
  - Import `BLOCK_DEFAULT_DATA`, `ICON_ONE_OF`. Mỗi preset bắt buộc template ≈ `BLOCK_DEFAULT_DATA[kind]`.
  - Icon field dùng `oneOf: ICON_ONE_OF` + `ui:widget = iconPicker`.
- `block-defaults.ts`
  - Định nghĩa data mẫu cho từng `kind` (hero, services, stats...). Dùng key Lucide (Film, Box, Lightbulb...).
- `block-form.tsx`
  - Array template mới với toggle, `iconPicker` widget, `MediaWidget` dùng dialog Convex.
  - `BlockForm` clone schema, gắn validator Ajv8, render Field/Object templates.
- `block-templates.ts`
  - `getTemplate(kind)` clone từ `BLOCK_DEFAULT_DATA` → nút “Chèn mẫu” dùng chung.
- Các section site (Services, WhyChooseUs, Why3DVisuals, WeWork)
  - Import `getLucideIcon` → icon render đúng theo preset/preview.
- Pipeline
  - Build (`bun run --cwd apps/web build`) kiểm tra icon export + type schema.

## AgentManifest JSON

```json
{
  "name": "home-blocks-presets",
  "version": "2.0.0",
  "context": ["dashboard.homeBlocks", "components.blockForm"],
  "ui": {
    "stack": ["next", "react-jsonschema-form", "shadcn/ui"],
    "registry": "apps/web/src/components/blocks/block-presets.ts",
    "widgets": ["iconPicker", "mediaImage", "mediaVideo", "textarea", "input"],
    "templates": {
      "field": "FieldTemplate",
      "array": "ArrayFieldTemplate (collapsible)",
      "object": "ObjectFieldTemplate"
    }
  },
  "dataFlow": {
    "schema": "preset.schema",
    "template": "BLOCK_DEFAULT_DATA[kind]",
    "source": "convex.pageBlocks",
    "twoWaySync": true
  },
  "actions": [
    { "name": "listPresets", "module": "block-presets.ts" },
    { "name": "renderForm", "module": "block-form.tsx" },
    { "name": "applyTemplate", "module": "block-templates.ts" },
    { "name": "pickIcon", "module": "block-form.tsx", "widget": "iconPicker" },
    { "name": "pickMedia", "module": "block-form.tsx", "widget": "mediaImage/mediaVideo" },
    { "name": "saveBlock", "convex": "pageBlocks.update" }
  ],
  "successCriteria": [
    "Thêm preset mới = sửa 1 file (block-presets + block-defaults)",
    "Icon hiển thị đúng trong form lẫn preview", 
    "Array dài có thể toggle, form dễ thao tác"
  ],
  "convex": {
    "queries": ["pageBlocks.getById", "media.list"],
    "mutations": ["pageBlocks.update", "pageBlocks.create"]
  }
}
```

## Feynman

Hãy tưởng tượng hệ thống là **một thư viện LEGO cao cấp**:

- `block-presets.ts` giống **sổ hướng dẫn**: mỗi block là một trang sách mô tả các mảnh ghép (schema) và vị trí của chúng (uiSchema).
- `block-defaults.ts` là **hộp LEGO mẫu đã ráp sẵn**: mỗi preset có một mô hình mẫu bạn có thể nhấn nút “Chèn mẫu” để dựng ngay.
- `iconPicker` và `lucide-icons.ts` là **kệ trưng bày các phụ kiện**: tất cả icon đều nằm ở một nơi, chọn icon nào thì hướng dẫn và mô hình đều hiểu giống nhau.
- `BlockForm` là **bàn ráp LEGO thông minh**: nhìn sách hướng dẫn, tự đặt sẵn khay (field), có công tắc đóng mở (toggle array), có hộp phụ kiện (media picker, icon picker).
- Khi muốn bổ sung block mới, bạn **tạo thêm một trang hướng dẫn + mô hình mẫu** → bàn ráp tự hiểu, không cần xây lại hệ thống.
- Build pipeline đóng vai trò **người quản thư viện**: nếu bạn tham chiếu phụ kiện chưa có (icon không tồn tại), sẽ báo ngay để bổ sung vào kệ.

Nhờ vậy đội admin vừa ráp nhanh (vì có mẫu), vừa an tâm (icon, dữ liệu, schema luôn khớp), còn dev mở rộng dễ dàng (tất cả tập trung vào 2 nguồn dữ liệu rõ ràng).
