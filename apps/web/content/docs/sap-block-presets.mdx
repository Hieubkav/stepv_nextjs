---
title: SAP - Block Presets Form Builder
description: Giai thich Scaffold, Approach, Pattern va Feynman cho giai phap block-presets.ts
---

## Muc tieu

- Dong bo hoa cach dinh nghia form cho Home Blocks bang mot registry duy nhat.
- Cho phep them/chinh sua preset bang JSON Schema (su dung @rjsf) ma khong phai sua nhieu file.
- Tich hop template JSON de admin bam "Chen mau" la co data mau ngay lap tuc.

## SAP

### Scaffold

- File chinh: `apps/web/src/components/blocks/block-presets.ts` (danh sach preset) + `block-form.tsx` (render form tu preset).
- Hoan doi template: `block-templates.ts` chi lay template tu preset thay vi tu tao.
- Duong dan doc: `apps/web/content/docs/sap-json-to-form.mdx` (tai lieu cu) + tai lieu nay lam ro them ve preset.

### Approach

1. Dong goi moi block vao preset gom `kind`, `name`, `schema`, `uiSchema`, `template`.
2. Khi render, `BlockForm` tao `Map` tu preset de tra cuu schema va uiSchema dua vao `kind` cua block.
3. Neu block co template thi `getTemplate(kind)` clone lai data mau cho nut "Chen mau".
4. Toan bo form duoc sinh boi `@rjsf/core` + widgets tuy chinh (image/video picker, textarea, input).
5. Them block moi chi can them mot preset moi (khong phai sua nhieu component).

### Pattern

- **Registry pattern**: toan bo preset nam trong mot array => convert sang `Map` de tra cuu nhanh, dam bao mot nguon su that.
- **Schema-driven UI**: su dung JSON Schema + uiSchema de tu sinh form, giam viec code tay component.
- **Template cloning**: mo hinh `JSON.parse(JSON.stringify(template))` de tao ban copy, tranh mutate preset goc.
- **Widget reuse**: tat ca truong primitive dung chung widget (Input, Textarea, media picker) thay vi lap lai code.

## Chi tiet

- `block-presets.ts`
  - Tra ve `BLOCK_PRESETS`: moi object dinh nghia day du label, format, placeholder cho form.
  - `template` co du lieu mau de admin co the bootstrap block.
- `block-form.tsx`
  - Doc preset, render `Form` su dung `validator-ajv8`.
  - Tich hop `FieldTemplate`, `ArrayFieldTemplate`, `ObjectFieldTemplate` tuong thich UI Shadcn.
  - Widgets `mediaImage`, `mediaVideo` goi Convex media picker.
- `block-templates.ts`
  - Lay template tu preset => giam duplicate du lieu.
- Them block: chi can append preset moi. Form + template + danh sach kind tu dong cap nhat.

## AgentManifest JSON

```json
{
  "name": "home-blocks-presets",
  "version": "1.0.0",
  "context": ["dashboard.homeBlocks", "components.blockForm"],
  "ui": {
    "stack": ["next", "react-jsonschema-form", "shadcn/ui"],
    "registry": "apps/web/src/components/blocks/block-presets.ts",
    "widgets": ["mediaImage", "mediaVideo", "textarea", "input"],
    "templates": {
      "field": "FieldTemplate",
      "array": "ArrayFieldTemplate",
      "object": "ObjectFieldTemplate"
    }
  },
  "dataFlow": {
    "source": "convex.pageBlocks",
    "props": ["data", "kind", "isVisible", "active"],
    "schema": "preset.schema",
    "twoWaySync": true
  },
  "actions": [
    { "name": "listPresets", "module": "block-presets.ts" },
    { "name": "renderForm", "module": "block-form.tsx" },
    { "name": "applyTemplate", "module": "block-templates.ts" },
    { "name": "pickMedia", "module": "block-form.tsx", "function": "MediaPickerDialog" },
    { "name": "saveBlock", "convex": "pageBlocks.update" }
  ],
  "successCriteria": [
    "Them preset moi ma khong phai sua block-form",
    "Form render dung schema preset",
    "Template mau duoc ap dung qua nut \"Chen mau\""
  ],
  "convex": {
    "queries": ["pageBlocks.getById", "media.list"],
    "mutations": ["pageBlocks.update", "pageBlocks.create"]
  }
}
```

## Feynman

- Tuong tu nhu mot cuon so mau: preset la trang huong dan ghi ro tung muc (kieu du lieu, nhan, placeholder).
- Khi admin mo form, `@rjsf` doc cuon so nay va bieu dien bang giao dien go chu, them dong, reorder.
- Neu muon tao mau moi, chi can them mot trang moi vao cuon so (mot preset moi); cac cong cu khac tu dong doc duoc ngay.
- Template chinh la ban sao mau da dien san, giup admin khong phai bat dau tu trang trong.
- Widget media hoat dong nhu them ong dung chung: moi preset co truong anh/video la co nut chon media san.
- Nhung buoc tren giup giam viec lap code va dam bao block nao cung dung chung mot bo quy tac.
