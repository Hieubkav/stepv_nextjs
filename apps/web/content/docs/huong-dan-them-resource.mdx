---
title: Thêm Resource mới (ví dụ Student)
description: Quy trình đầy đủ để thêm bảng Student với CRUD trong /admin
---

Tài liệu này hướng dẫn từng bước để thêm một resource mới vào dự án, ví dụ cụ thể với bảng `Student`. Kết quả cuối cùng: bạn có trang quản trị `/admin/students` với đầy đủ CRUD, tìm kiếm, lọc, phân trang, và bulk actions, tương tự như `Todos` hiện có.

## Kiến trúc nhanh

- Backend (Convex): `packages/backend/convex`
  - Khai báo bảng: `schema.ts`
  - Hàm query/mutation: mỗi resource 1 file (ví dụ `students.ts`)
  - Codegen types: `npx convex codegen`
- Frontend (Next.js): `apps/web`
  - Admin: `/src/app/(admin)/admin/*`
  - Mỗi resource 1 thư mục con: `.../admin/<resource>/`
  - Dùng shadcn/ui + Tailwind v4

---

## 1) Backend: tạo bảng Student và API

### 1.1 Khai báo bảng trong `schema.ts`

Thêm bảng `students` (ví dụ cột cơ bản: `name`, `email`, `className`, `active`). Bạn có thể mở rộng thêm cột theo nhu cầu.

```ts title="packages/backend/convex/schema.ts" {4-10}
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  // Bảng Todos có sẵn...
  todos: defineTable({
    text: v.string(),
    completed: v.boolean(),
  }),

  // Thêm bảng Students
  students: defineTable({
    name: v.string(),
    email: v.string(),
    className: v.string(),
    active: v.boolean(),
  }),
});
```

### 1.2 Tạo file `students.ts` với các hàm CRUD + list

Tạo `packages/backend/convex/students.ts`:

```ts title="packages/backend/convex/students.ts"
import { query, mutation } from "./_generated/server";
import { v } from "convex/values";

export const list = query({
  args: {
    search: v.optional(v.string()), // tìm theo tên/email
    active: v.optional(v.union(v.literal("all"), v.literal("true"), v.literal("false"))),
    offset: v.number(),
    limit: v.number(),
  },
  handler: async (ctx, { search, active = "all", offset, limit }) => {
    let items = await ctx.db.query("students").collect();

    if (active !== "all") items = items.filter((s) => String(s.active) === active);
    if (search && search.trim()) {
      const s = search.trim().toLowerCase();
      items = items.filter((x) => x.name.toLowerCase().includes(s) || x.email.toLowerCase().includes(s));
    }

    items.sort((a, b) => b._creationTime - a._creationTime);
    const total = items.length;
    const page = items.slice(offset, offset + limit);
    return { items: page, total };
  },
});

export const getById = query({
  args: { id: v.id("students") },
  handler: async (ctx, { id }) => ctx.db.get(id),
});

export const create = mutation({
  args: { name: v.string(), email: v.string(), className: v.string(), active: v.boolean() },
  handler: async (ctx, args) => {
    const id = await ctx.db.insert("students", args);
    return await ctx.db.get(id);
  },
});

export const update = mutation({
  args: { id: v.id("students"), name: v.string(), email: v.string(), className: v.string(), active: v.boolean() },
  handler: async (ctx, { id, ...rest }) => {
    await ctx.db.patch(id, rest);
    return { success: true };
  },
});

export const remove = mutation({
  args: { id: v.id("students") },
  handler: async (ctx, { id }) => {
    await ctx.db.delete(id);
    return { success: true };
  },
});

export const bulkRemove = mutation({
  args: { ids: v.array(v.id("students")) },
  handler: async (ctx, { ids }) => {
    for (const id of ids) await ctx.db.delete(id);
    return { success: true, count: ids.length };
  },
});
```

### 1.3 Chạy codegen để có types

```bash
cd packages/backend
npx convex codegen
```

Nếu chạy local: `bun run dev:server`. Khi sẵn sàng, `npx convex deploy` để deploy functions lên cloud.

---

## 2) Frontend Admin: scaffold trang list/new/edit

Thư mục gợi ý: `apps/web/src/app/(admin)/admin/students/*`

### 2.1 Thêm link menu vào sidebar Admin

Mở `apps/web/src/app/(admin)/admin/layout.tsx`, bổ sung vào mảng `nav`:

```ts {2}
const nav = [
  { href: "/admin/todos", label: "Công việc", icon: LucideListTodo },
  { href: "/admin/students", label: "Học viên", icon: Users }, // thêm dòng này
] as const;
```

Nhớ import icon phù hợp từ `lucide-react`, ví dụ: `import { Users } from "lucide-react";`.

### 2.2 Danh sách: `/admin/students/page.tsx`

Tương tự Todos, tạo trang liệt kê có tìm kiếm theo tên/email, lọc theo trạng thái, phân trang, và bulk delete.

```tsx title="apps/web/src/app/(admin)/admin/students/page.tsx"
"use client";
import { useMemo, useState } from "react";
import { useQuery, useMutation } from "convex/react";
import { api } from "@dohy/backend/convex/_generated/api";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Checkbox } from "@/components/ui/checkbox";
import { Card } from "@/components/ui/card";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu";
import { toast } from "sonner";
import { Plus, MoreHorizontal, Trash2, Search } from "lucide-react";

export default function StudentsListPage() {
  const [search, setSearch] = useState("");
  const [active, setActive] = useState<"all" | "true" | "false">("all");
  const [page, setPage] = useState(1);
  const pageSize = 10;
  const args = useMemo(() => ({ search: search || undefined, active, offset: (page - 1) * pageSize, limit: pageSize }), [search, active, page]);

  const data = useQuery(api.students.list, args);
  const remove = useMutation(api.students.remove);
  const bulkRemove = useMutation(api.students.bulkRemove);

  const [selected, setSelected] = useState<string[]>([]);
  const items = data?.items ?? [];
  const idsOnPage = items.map((i) => i._id as unknown as string);
  const total = data?.total ?? 0;
  const totalPages = Math.max(1, Math.ceil(total / pageSize));

  function toggleSelect(id: string, checked: boolean) {
    setSelected((prev) => (checked ? [...new Set([...prev, id])] : prev.filter((x) => x !== id)));
  }

  async function onBulkRemove() {
    const ids = selected.filter((id) => idsOnPage.includes(id));
    if (ids.length === 0) return;
    await bulkRemove({ ids: ids as any });
    setSelected((prev) => prev.filter((x) => !ids.includes(x)));
    toast.success("Đã xóa các mục đã chọn");
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-xl font-semibold">Học viên</h1>
        <Button asChild>
          <Link href="/admin/students/new"><Plus className="mr-1.5 size-4"/> Thêm mới</Link>
        </Button>
      </div>

      <Card className="p-4 space-y-4">
        <div className="flex flex-wrap items-center gap-2">
          <div className="relative">
            <Search className="absolute left-2 top-1/2 -translate-y-1/2 size-4 text-muted-foreground" />
            <Input placeholder="Tìm theo tên hoặc email..." value={search} onChange={(e) => { setPage(1); setSearch(e.target.value); }} className="pl-8 w-72" />
          </div>
          <div className="ml-auto flex gap-2">
            {(["all","true","false"] as const).map((s) => (
              <Button key={s} variant={active === s ? "default" : "secondary"} onClick={() => { setPage(1); setActive(s); }}>
                {s === "all" ? "Tất cả" : s === "true" ? "Đang học" : "Ngừng học"}
              </Button>
            ))}
          </div>
        </div>

        <div className="flex items-center gap-2">
          <Button variant="destructive" disabled={selected.length === 0} onClick={onBulkRemove}><Trash2 className="mr-1.5 size-4"/> Xóa đã chọn</Button>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="border-b text-muted-foreground">
                <th className="py-2 pr-2 text-left font-medium">Chọn</th>
                <th className="py-2 px-2 text-left font-medium">Tên</th>
                <th className="py-2 px-2 text-left font-medium">Email</th>
                <th className="py-2 px-2 text-left font-medium">Lớp</th>
                <th className="py-2 px-2 text-left font-medium">Trạng thái</th>
                <th className="py-2 pl-2 text-right font-medium">Thao tác</th>
              </tr>
            </thead>
            <tbody>
              {items.map((s) => {
                const id = s._id as unknown as string;
                return (
                  <tr key={id} className="border-b last:border-0">
                    <td className="py-2 pr-2"><Checkbox checked={selected.includes(id)} onCheckedChange={(v) => toggleSelect(id, Boolean(v))} /></td>
                    <td className="py-2 px-2">{s.name}</td>
                    <td className="py-2 px-2">{s.email}</td>
                    <td className="py-2 px-2">{s.className}</td>
                    <td className="py-2 px-2">{s.active ? "Đang học" : "Ngừng học"}</td>
                    <td className="py-2 pl-2 text-right">
                      <DropdownMenu>
                        <DropdownMenuTrigger asChild><Button size="sm" variant="ghost"><MoreHorizontal className="size-4"/></Button></DropdownMenuTrigger>
                        <DropdownMenuContent align="end">
                          <DropdownMenuItem asChild><Link href={`/admin/students/${id}/edit`}>Sửa</Link></DropdownMenuItem>
                          <DropdownMenuItem className="text-red-600" onClick={async () => { await remove({ id: s._id }); toast.success("Đã xóa 1 học viên"); }}>Xóa</DropdownMenuItem>
                        </DropdownMenuContent>
                      </DropdownMenu>
                    </td>
                  </tr>
                );
              })}
              {data === undefined && (
                <tr><td colSpan={6} className="py-6 text-center text-muted-foreground">Đang tải...</td></tr>
              )}
              {data && items.length === 0 && (
                <tr><td colSpan={6} className="py-6 text-center text-muted-foreground">Không có học viên phù hợp</td></tr>
              )}
            </tbody>
          </table>
        </div>

        <div className="flex items-center justify-between">
          <div className="text-sm text-muted-foreground">{total > 0 ? `Hiển thị ${(page-1)*pageSize+1}–${Math.min(page*pageSize,total)} / ${total}` : ""}</div>
          <div className="flex gap-2">
            <Button variant="outline" disabled={page===1} onClick={() => setPage((p)=>Math.max(1,p-1))}>Trước</Button>
            <div className="text-sm">Trang {page} / {totalPages}</div>
            <Button variant="outline" disabled={page>=totalPages} onClick={() => setPage((p)=>Math.min(totalPages,p+1))}>Sau</Button>
          </div>
        </div>
      </Card>
    </div>
  );
}
```

### 2.3 Tạo mới: `/admin/students/new/page.tsx`

```tsx title="apps/web/src/app/(admin)/admin/students/new/page.tsx"
"use client";
import { useState } from "react";
import { useMutation } from "convex/react";
import { api } from "@dohy/backend/convex/_generated/api";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card } from "@/components/ui/card";
import { useRouter } from "next/navigation";
import { toast } from "sonner";

export default function StudentsNewPage() {
  const [name, setName] = useState("");
  const [email, setEmail] = useState("");
  const [className, setClassName] = useState("");
  const [active, setActive] = useState(true);
  const create = useMutation(api.students.create);
  const router = useRouter();

  async function onSubmit() {
    if (!name.trim() || !email.trim() || !className.trim()) return toast.error("Vui lòng nhập đủ thông tin");
    await create({ name: name.trim(), email: email.trim(), className: className.trim(), active });
    toast.success("Tạo học viên thành công");
    router.push("/admin/students");
  }

  return (
    <div className="space-y-6">
      <h1 className="text-xl font-semibold">Thêm học viên</h1>
      <Card className="p-4 space-y-4">
        <div className="grid gap-3 sm:grid-cols-2">
          <div className="space-y-1"><label>Tên</label><Input value={name} onChange={(e)=>setName(e.target.value)}/></div>
          <div className="space-y-1"><label>Email</label><Input value={email} onChange={(e)=>setEmail(e.target.value)}/></div>
          <div className="space-y-1 sm:col-span-2"><label>Lớp</label><Input value={className} onChange={(e)=>setClassName(e.target.value)}/></div>
          <div className="space-y-1 sm:col-span-2"><label>Trạng thái</label>
            <select className="h-9 rounded-md border bg-transparent px-3" value={active?"true":"false"} onChange={(e)=>setActive(e.target.value==="true")}> 
              <option value="true">Đang học</option>
              <option value="false">Ngừng học</option>
            </select>
          </div>
        </div>
        <div className="flex gap-2"><Button onClick={onSubmit}>Lưu</Button><Button variant="secondary" onClick={()=>router.back()}>Hủy</Button></div>
      </Card>
    </div>
  );
}
```

### 2.4 Sửa: `/admin/students/[id]/edit/page.tsx`

```tsx title="apps/web/src/app/(admin)/admin/students/[id]/edit/page.tsx"
"use client";
import { useEffect, useState } from "react";
import { useQuery, useMutation } from "convex/react";
import { api } from "@dohy/backend/convex/_generated/api";
import type { Id } from "@dohy/backend/convex/_generated/dataModel";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card } from "@/components/ui/card";
import { useParams, useRouter } from "next/navigation";
import { toast } from "sonner";

export default function StudentsEditPage() {
  const { id } = useParams<{ id: string }>();
  const router = useRouter();
  const studentId = id as unknown as Id<"students">;
  const data = useQuery(api.students.getById, { id: studentId });
  const update = useMutation(api.students.update);

  const [name, setName] = useState("");
  const [email, setEmail] = useState("");
  const [className, setClassName] = useState("");
  const [active, setActive] = useState(true);

  useEffect(() => {
    if (data) {
      setName(data.name);
      setEmail(data.email);
      setClassName(data.className);
      setActive(data.active);
    }
  }, [data]);

  async function onSubmit() {
    if (!data) return;
    if (!name.trim() || !email.trim() || !className.trim()) return toast.error("Vui lòng nhập đủ thông tin");
    await update({ id: data._id, name: name.trim(), email: email.trim(), className: className.trim(), active });
    toast.success("Cập nhật học viên thành công");
    router.push("/admin/students");
  }

  return (
    <div className="space-y-6">
      <h1 className="text-xl font-semibold">Sửa học viên</h1>
      <Card className="p-4 space-y-4">
        {data === undefined ? (
          <div className="text-muted-foreground">Đang tải...</div>
        ) : !data ? (
          <div className="text-red-600">Không tìm thấy học viên</div>
        ) : (
          <>
            <div className="grid gap-3 sm:grid-cols-2">
              <div className="space-y-1"><label>Tên</label><Input value={name} onChange={(e)=>setName(e.target.value)}/></div>
              <div className="space-y-1"><label>Email</label><Input value={email} onChange={(e)=>setEmail(e.target.value)}/></div>
              <div className="space-y-1 sm:col-span-2"><label>Lớp</label><Input value={className} onChange={(e)=>setClassName(e.target.value)}/></div>
              <div className="space-y-1 sm:col-span-2"><label>Trạng thái</label>
                <select className="h-9 rounded-md border bg-transparent px-3" value={active?"true":"false"} onChange={(e)=>setActive(e.target.value==="true")}> 
                  <option value="true">Đang học</option>
                  <option value="false">Ngừng học</option>
                </select>
              </div>
            </div>
            <div className="flex gap-2"><Button onClick={onSubmit}>Lưu</Button><Button variant="secondary" onClick={()=>router.back()}>Hủy</Button></div>
          </>
        )}
      </Card>
    </div>
  );
}
```

---

## 3) Kiểm tra nhanh

1. Chạy backend local (tùy chọn): `bun run dev:server`
2. Chạy web: `bun run dev:web`
3. Mở `/admin/students` để kiểm tra list, tạo/sửa/xóa, tìm kiếm, lọc, phân trang, bulk xóa

Nếu dùng Convex cloud, sau khi thêm/đổi functions hãy deploy: `cd packages/backend && npx convex deploy`.

---

## 4) Lưu ý và mở rộng

- Search hiện tại lọc trong bộ nhớ; với dữ liệu lớn hãy tạo index hoặc search hợp lý trong Convex để tối ưu.
- Bạn có thể tái sử dụng pattern của `Todos` để thêm bulk toggle, thêm trường ngày sinh, v.v.
- Giữ UI/UX nhất quán: dùng shadcn/ui, Tailwind v4 variables đã cấu hình, toast tiếng Việt.

